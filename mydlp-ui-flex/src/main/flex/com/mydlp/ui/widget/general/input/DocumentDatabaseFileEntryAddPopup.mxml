<?xml version="1.0" encoding="utf-8"?>
<s:TitleWindow xmlns:fx="http://ns.adobe.com/mxml/2009" 
			   xmlns:s="library://ns.adobe.com/flex/spark" 
			   xmlns:mx="library://ns.adobe.com/flex/mx"
			   xmlns:input="com.mydlp.ui.widget.general.input.*"
			   close="{close()}"
			   visible="false"
			   title="@Resource(bundle = 'messages', key = 'documentDatabase.add.title.label')"
			   width="300" height="200"
			   >
	
	
	<fx:Script>
		<![CDATA[
			import com.mydlp.ui.domain.DocumentDatabaseFileEntry;
			import com.mydlp.ui.util.InteractionUtil;
			import com.mydlp.ui.util.Md5Util;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.events.DragEvent;
			import mx.events.FlexEvent;
			import mx.managers.DragManager;
			import mx.rpc.events.ResultEvent;
			
			private var refUploadFile:FileReference;
			private var refUploadFileList:FileReferenceList;
			private var fileListArray:Array;
			
			public var ddfeInput:DocumentDatabaseFileEntryInput = null;
			
			protected var remaining:int = 0;
			
			protected function close(): void
			{
				InteractionUtil.closePopup(this);
			}
			
			protected function uploadButton(event:MouseEvent):void
			{
				refUploadFileList = new FileReferenceList();
				refUploadFile = new FileReference();
				refUploadFileList.browse(); 
				refUploadFileList.addEventListener(Event.SELECT,onFileSelect); 
			}
			
			protected function loadEachFile(file:FileReference):void
			{
				file.addEventListener(Event.COMPLETE, onFileComplete);
				file.load();
			}
			
			protected function onFileSelect(event:Event):void
			{
				refUploadFileList = event.currentTarget as FileReferenceList;
				fileListArray = refUploadFileList.fileList;
				remaining = fileListArray.length;
				for(var i:int = 0; i < fileListArray.length; i++)
				{
					var file:FileReference = fileListArray[i] as FileReference;
					loadEachFile(file);
				}
			}
			
			protected function onFileComplete(event:Event):void
			{
				var fileRef:FileReference = event.currentTarget as FileReference;
				
				var data:ByteArray = new ByteArray();
				fileRef.data.readBytes(data, 0, fileRef.data.length);
				var md5sum:String = Md5Util.hashBinary(data); 
				
				var ddfe:DocumentDatabaseFileEntry = new DocumentDatabaseFileEntry();
				ddfe.filename = fileRef.name;
				ddfe.md5Hash = md5sum;
				
				ddfeInput.addEntry(ddfe);
				remaining--;
				if (remaining == 0)
					close();
			}
			
			public function populate():void
			{				
				visible = true;
			}
			
		]]>
	</fx:Script>
	
	<s:Group>
		
		<s:layout>
			<s:HorizontalLayout horizontalAlign="center" gap="5" verticalAlign="middle" 
							  paddingLeft="8" paddingRight="8"
							  paddingTop="15" paddingBottom="15"/>
		</s:layout>
		
		<s:Button label="@Resource(key='documentDatabase.fileUpload.browse', bundle='messages')"
				  click="uploadButton(event)" />
					
		<s:Button label="@Resource(bundle = 'messages', key = 'documentDatabase.button.cancel.label')" 
				  click="{close()}"/>
		
	</s:Group>
	
</s:TitleWindow>
